<!DOCTYPE html>
<html>
	<head>
		<title>Graph coloring sandbox</title>
		<style type="text/css">
html , body {
	background: #eee; 
	color: #999; 
	margin: 0; 
	padding: 0;
}
#canvas {
	position: absolute;
	left: 0; right: 0; top: 0; bottom: 0; 
	margin: 0;
	padding:0;
	overflow:hidden;
}

.graph-nav-info {
    position: absolute;
    bottom: 5px;
    width: 100%;
    text-align: center;
    color: slategrey;
    opacity: 0.7;
    font-size: 10px;
}

.graph-info-msg {
    position: absolute;
    top: 50%;
    width: 100%;
    text-align: center;
    color: lavender;
    opacity: 0.7;
    font-size: 22px;
}

.graph-tooltip {
    position: absolute;
    color: lavender;
    font-size: 18px;
}
		</style>
		<style type="text/css" src="style/dat.gui.css"></style>
		<script type="text/javascript" src="socket.io/socket.io.js"></script>
		<script type="text/javascript" src="js/d3.js"></script>
		<script type="text/javascript" src="js/colors.js"></script>
		<script type="text/javascript" src="js/dat.gui.js"></script>
		<script type="text/javascript" src="js/three.js"></script>
		<script type="text/javascript" src="js/EffectComposer.js"></script>
		<script type="text/javascript" src="js/RenderPass.js"></script>
		<script type="text/javascript" src="js/ShaderPass.js"></script>
		<script type="text/javascript" src="js/CopyShader.js"></script>
		
		
		<script type="text/javascript" src="js/controls.js"></script>
		<script type="text/javascript" src="js/d3-force-3d.js"></script>
		<script type="text/javascript" src="js/3d-force-graph.js"></script>

	</head>

	<body>
		<div id="canvas" height="100%" width="100%"></div>
		
		
		<script type="text/javascript">
		
var canvas,	
	context,	
	socket,
	color,playersDiv,
	searchRadius,
	worldLayout,worldsLayout,activeLayout;

var world={},worlds={},cards;
function updateworldInfo(){playersDiv.selectAll("p").data(Object.values(world.players)).enter().append("p").text(function(d){return JSON.stringify(d);});}//??!!

function init() {
	color = d3.scaleOrdinal(d3.schemeCategory20);
	playersDiv=d3.select("#playersDisplay");
	canvas=d3.select("#canvas").node();
	socket = io.connect("/", {  transports: [ "websocket","flashsocket","polling" ] });
	//window.addEventListener("resize", onResize, false);
	socket.on("connect", function(data) {
		console.log("Connected to socket server");
	});
	socket.on("disconnect", function(data) {
		console.log("Disconnected from socket server");
	});

	socket.on("enter world", function(data) {
		world=data;world.links={};preprocess(world);graph3d.show(world);
	});
	
	socket.on("color node" ,function onColorNode(data){graph3d.colorNode(data.id,data);} );
	socket.on("label node" ,function onLabelNode(data){graph3d.labelNode(data.id,data.text);} );
	
	socket.on("add node" ,function onAddNode(data){graph3d.addNode(data);} );
	socket.on("delete node" ,function(data){graph3d.deleteNode(data)} );
	socket.on("add link" ,function(data){ graph3d.addLink(data.source,data.target)} );
	socket.on("delete link" ,function(data){ graph3d.deleteLink(data.source,data.target);} );

	graph3d.ontextchange=function labelNode(value){
		if(graph3d.selectedNode){
			socket.emit("label node",{id:graph3d.selectedNode.id,text:value});
		}
	}
	graph3d.onclick=function clicked(target){
		if(target)
		{
			var sphere;
			if(graph3d.selectedNode){
				if(graph3d.selectedNode!=target){
					console.log("clicked on another node");
					if(graph3d.selectedNode.links[target.id])
					{
						console.log("deleting link "+graph3d.selectedNode.id+","+target.id);
						socket.emit("delete link",{source:graph3d.selectedNode.id,target:target.id});
					}
					else {
						console.log("adding link "+graph3d.selectedNode.id+","+target.id);
						socket.emit("add link",{source:graph3d.selectedNode.id,target:target.id});
					}
				}
				else
				{
					graph3d.deselectNode();
				}
			}
			else
			{
				graph3d.selectNode(target);
			}
		}
		else
		{
			if(graph3d.selectedNode){
				graph3d.deselectNode();
			}
		}
	}
	graph3d.onrightclick=function (target){
		if(target)
		{//color nodes - to make sure nodes are all easily visible, we keep track of hue and saturation and use that to color nodes, but all luminances should be kept somewhat constant visually(black nodes would be dar inside but have a light grey outer glow, and white nodes have the same outer glow, for example)
			var c=graph3d.chosenColor;
			socket.emit("color node",{h:c.h,s:c.s,v:c.v,id:target.id});//using a consistent set of ranges: 360, 100, and 100.
		}
		else
		{//for want of a better input method, this is for node "dragging" - actual dragging is too easy to confuse with camera operations
			if(graph3d.selectedNode){
				var pos=graph3d.getAlignedMousePosition3d(graph3d.selectedNode.__sphere);
				if(pos)
				{
					graph3d.targetNodeLocation=pos;//this gradually makes the selected node fly to that place
				}
				else{console.log("too far away");}
			}
		}
	}
	graph3d.ondblclick=	function dblclicked(target){
		if(target)
		{
			if(graph3d.selectedNode==target){//remove the selection first
				sphere=graph3d.selectedNode.__sphere;
				sphere.remove(graph3d.selectMark);
				graph3d.selectedNode=undefined;
				socket.emit("delete node",target.id);
			}
			else{
				//since double click triggers a click first and I don't want to add a delay here, have to use single clicks for link operations
			}
		}
		else
		{
		//todo first try moving a degree 0 node to where the player wants if there's a surplus - no need to keep creating so many nodes?
			var pos=graph3d.getMousePosition3d();
			if(pos)
			{
				graph3d.newNodePositions.push(pos);
				socket.emit("add node");
			}
			else{console.log("too far away");}
		}
		
	}

	canvas.innerHTML = '';

	init3d(canvas);
	
	
}

init();
////////////////////////////////////////////////
function preprocess(data)
{//for when nodes are given as an array (with elements having ids); we need a map
	data.nodesMap={};data.linksMap={};//here the incoming nodes is a map. we need nodes to be an array for d3
	for(var id in data.nodes){
		data.nodesMap[data.nodes[id].id]=data.nodes[id];
		for(var target in data.nodes[id].links)
		{
			if(Number(target)>Number(id)){data.linksMap[id+"-"+target]={source:id,target:target};}
		}
	}
	data.nodes=Object.values(data.nodesMap);
	data.links=Object.values(data.linksMap);
}

		</script>
	</body>
</html>